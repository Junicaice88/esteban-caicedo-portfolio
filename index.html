<script>
  // Utilidad: detecta si es video
  const isVideo = (src) => /\.mp4($|\?)/i.test(src);

  // Crea una capa (img o video) para el slider
  function makeMediaLayer(src) {
    const layer = document.createElement('div');
    layer.className = 'slide-layer';
    if (isVideo(src)) {
      const v = document.createElement('video');
      v.src = src;
      v.muted = true;
      v.playsInline = true;
      v.loop = true;
      v.autoplay = true;
      v.style.width = '100%';
      v.style.height = '100%';
      v.style.objectFit = 'cover';
      layer.appendChild(v);
    } else {
      const img = document.createElement('img');
      img.src = src;
      img.loading = 'lazy';
      layer.appendChild(img);
    }
    return layer;
  }

  // Slider cross-fade (acepta imágenes y videos)
  function mountSlider(container, sources, height = 260, opts = {}) {
    const autoplay = opts.autoplay !== false;
    const interval = opts.interval || 3000;

    container.classList.add('slider');
    container.style.height = height + 'px';

    const a = makeMediaLayer(sources[0] || '');
    const b = makeMediaLayer(sources[1] || sources[0] || '');
    a.classList.add('active');
    container.append(a, b);

    // Controles hover
    const left = document.createElement('div');
    left.className = 'ctrl left'; left.textContent = '‹';
    const right = document.createElement('div');
    right.className = 'ctrl right'; right.textContent = '›';
    container.append(left, right);

    // Dots
    const dots = document.createElement('div'); dots.className = 'dots';
    sources.forEach((_, i) => {
      const d = document.createElement('span'); d.className = 'dot' + (i===0?' active':'');
      d.onclick = () => show(i);
      dots.appendChild(d);
    });
    container.appendChild(dots);

    let idx = 0, timer = null, useA = true;

    function show(n) {
      idx = (n + sources.length) % sources.length;
      const next = sources[idx];

      const front = useA ? a : b;
      const back  = useA ? b : a;
      const media = makeMediaLayer(next);
      back.replaceChildren(...media.childNodes);

      // crossfade
      front.classList.remove('active');
      back.classList.add('active');
      useA = !useA;

      [...dots.children].forEach((d, i) => d.className = 'dot' + (i===idx?' active':''));      
    }

    function start(){ if(autoplay && sources.length > 1) timer = setInterval(()=>show(idx+1), interval); }
    function stop(){ if(timer){ clearInterval(timer); timer=null; } }

    left.onclick = ()=>show(idx-1);
    right.onclick = ()=>show(idx+1);
    container.addEventListener('mouseenter', stop);
    container.addEventListener('mouseleave', start);

    start();
  }

  // Render cards (usa p.media || p.images para permitir ambos)
  fetch('projects.json').then(r => r.json()).then(items => {
    const grid = document.getElementById('grid');
    items.forEach(p => {
      const card = document.createElement('a');
      card.href = `project.html?slug=${encodeURIComponent(p.slug)}`;
      card.className = 'card';

      const slider = document.createElement('div');
      const sources = (p.media && p.media.length ? p.media : (p.images || [])).slice();
      // fallback visual si no hay fuentes
      if (sources.length === 0) sources.push('assets/images/Airplane Model1.jpg');

      // altura acorde a tu diseño (v2.3.4)
      mountSlider(slider, sources, 260, {autoplay:true});

      const body = document.createElement('div');
      body.className = 'card-body';
      body.innerHTML = `
        <h3>${p.title}</h3>
        <p>${p.description || ''}</p>
        <div class="tags">${(p.tags||[]).map(t => `<span>${t}</span>`).join('')}</div>
      `;

      card.append(slider, body);
      grid.appendChild(card);
    });
  });
</script>
