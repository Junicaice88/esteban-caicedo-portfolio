<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Project</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body{background:#0b1220;color:#e4e7ee}
    .card{background:#161b2a;border:1px solid rgba(255,255,255,.08);border-radius:16px}
    .viewer-wrap{min-height:420px}
    .slider{position:relative;overflow:hidden}
    .slide{display:none}
    .slide.active{display:block}
    .dot{width:8px;height:8px;border-radius:999px;background:#93a3ff33}
    .dot.active{background:#93a3ff}
    .ctrl{position:absolute;top:50%;transform:translateY(-50%);background:rgba(0,0,0,.45);color:#fff;border-radius:8px;padding:6px 8px;cursor:pointer;user-select:none}
    .ctrl.left{left:8px}.ctrl.right{right:8px}
  </style>
</head>
<body class="font-sans">
  <div class="max-w-6xl mx-auto px-4 py-8">
    <a href="index.html" class="text-sm text-indigo-300 hover:text-indigo-200">← Back</a>
    <h1 id="title" class="text-3xl font-semibold mt-3">Project</h1>
    <p id="desc" class="text-slate-300 mt-2"></p>

    <div class="grid md:grid-cols-2 gap-6 mt-6">
      <div class="card p-3 viewer-wrap">
        <div id="viewer" class="w-full h-[420px] md:h-[520px] rounded-xl overflow-hidden"></div>
      </div>
      <div class="card p-3">
        <div id="mediaSlider" class="slider rounded-xl overflow-hidden"></div>
        <div id="dots" class="flex gap-2 justify-center mt-3"></div>
      </div>
    </div>

    <p id="long" class="text-slate-300 mt-6"></p>
    <div id="tags" class="flex flex-wrap gap-2 mt-3"></div>
  </div>

  <script type="module">
    import * as THREE from "https://cdn.jsdelivr.net/npm/three@0.160/build/three.module.js";
    import { OrbitControls } from "https://cdn.jsdelivr.net/npm/three@0.160/examples/jsm/controls/OrbitControls.js";
    import { GLTFLoader } from "https://cdn.jsdelivr.net/npm/three@0.160/examples/jsm/loaders/GLTFLoader.js";

    const $ = s => document.querySelector(s);
    const params = new URLSearchParams(location.search);
    const slug = params.get('slug');

    // --- Carga proyecto ---
    const projects = await fetch("projects.json").then(r=>r.json());
    const proj = projects.find(p => p.slug === slug);

    if (!proj) {
      $("#title").textContent = "Project not found";
      throw new Error("Slug not found in projects.json");
    }

    $("#title").textContent = proj.title;
    $("#desc").textContent = proj.description || "";
    $("#long").textContent = proj.longDescription || "";
    $("#tags").innerHTML = (proj.tags||[]).map(t =>
      `<span class="px-2 py-1 rounded-lg bg-indigo-500/10 text-indigo-300 border border-indigo-400/20 text-sm">${t}</span>`
    ).join("");

    // --- Slider imágenes/videos ---
    const media = [
      ...(proj.images||[]).map(src => ({type:"img", src})),
      ...(proj.videos||[]).map(src => ({type:"video", src}))
    ];
    const slider = $("#mediaSlider");
    const dotsWrap = $("#dots");
    let idx = 0;

    function renderSlider(){
      slider.innerHTML = "";
      media.forEach((m,i)=>{
        const el = document.createElement(m.type === "img" ? "img" : "video");
        el.className = "slide w-full rounded-xl";
        if (m.type==="img"){ el.src = m.src; el.loading="lazy"; }
        else { el.src = m.src; el.controls = true; el.playsInline = true; }
        if (i===idx) el.classList.add("active");
        slider.appendChild(el);
      });
      if (media.length > 1) {
        const left = Object.assign(document.createElement("div"), {className:"ctrl left", textContent:"‹"});
        const right = Object.assign(document.createElement("div"), {className:"ctrl right", textContent:"›"});
        left.onclick = ()=>{ idx=(idx-1+media.length)%media.length; renderSlider(); };
        right.onclick = ()=>{ idx=(idx+1)%media.length; renderSlider(); };
        slider.append(left,right);
      }
      dotsWrap.innerHTML = "";
      media.forEach((_,i)=>{
        const d = Object.assign(document.createElement("div"), {className: "dot"+(i===idx?" active":"")});
        d.onclick = ()=>{ idx=i; renderSlider(); };
        dotsWrap.appendChild(d);
      });
    }
    renderSlider();

    // --- Visor 3D ---
    const viewer = $("#viewer");
    if (!proj.model) {
      viewer.innerHTML = `<div class="w-full h-full grid place-items-center text-slate-400">No 3D model</div>`;
    } else {
      const scene = new THREE.Scene();
      scene.background = new THREE.Color(0x0b1220);

      const renderer = new THREE.WebGLRenderer({ antialias:true, powerPreference:"high-performance" });
      viewer.appendChild(renderer.domElement);

      const camera = new THREE.PerspectiveCamera(50, 1, 0.1, 1000);
      camera.position.set(2.5, 1.6, 3.0);

      const controls = new OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;

      const hemi = new THREE.HemisphereLight(0xffffff, 0x222244, 1.05);
      scene.add(hemi);
      const dir = new THREE.DirectionalLight(0xffffff, 1.0);
      dir.position.set(3,5,7);
      scene.add(dir);

      const grid = new THREE.GridHelper(10, 10, 0x334, 0x112);
      grid.material.opacity = 0.25; grid.material.transparent = true;
      scene.add(grid);

      function resize(){
        const w = viewer.clientWidth || 600;
        const h = viewer.clientHeight || 420;
        renderer.setSize(w, h, false);
        camera.aspect = w / h;
        camera.updateProjectionMatrix();
      }
      // tamaño inicial + observador
      resize();
      new ResizeObserver(resize).observe(viewer);

      const loader = new GLTFLoader();
      const modelURL = encodeURI(proj.model); // soporta espacios

      loader.load(
        modelURL,
        gltf=>{
          const root = gltf.scene || gltf.scenes[0];
          // Normalizar tamaño a ~2 unidades
          const box = new THREE.Box3().setFromObject(root);
          const size = box.getSize(new THREE.Vector3()).length();
          const center = box.getCenter(new THREE.Vector3());
          root.position.sub(center);      // centrar
          root.scale.setScalar(2 / size); // escalar
          scene.add(root);

          (function animate(){
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
          })();
        },
        undefined,
        err=>{
          console.error("GLB load error:", err);
          viewer.innerHTML = `<div class="w-full h-full grid place-items-center text-red-300 text-center p-4">
            Error loading model:<br/><code>${proj.model}</code>
          </div>`;
        }
      );
    }
  </script>
</body>
</html>
