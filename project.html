<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Project • Esteban Caicedo</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/three@0.160.1/build/three.min.js"></script>
  <script src="https://unpkg.com/three@0.160.1/examples/js/controls/OrbitControls.js"></script>
  <script src="https://unpkg.com/three@0.160.1/examples/js/loaders/STLLoader.js"></script>
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
  <style>
    :root{color-scheme: dark;}
    html,body{background:#0b1322;color:#e6edf3}
    .card{background:#0f172a;border:1px solid rgba(255,255,255,.08)}
    .fade-slide{position:relative;overflow:hidden;border-radius:16px}
    .fade-slide > *{position:absolute;inset:0;opacity:0;transition:opacity .6s ease}
    .fade-slide > *.active{opacity:1}
    .dot{width:.5rem;height:.5rem;border-radius:9999px;background:rgba(255,255,255,.25)}
    .dot.active{background:white}
  </style>
</head>
<body>
  <header class="max-w-6xl mx-auto px-5 py-6 flex items-center justify-between">
    <a class="text-xl font-semibold text-blue-300" href="./">Esteban Caicedo</a>
    <a class="text-sm text-slate-300 hover:text-white" href="./#projects">← Back</a>
  </header>
  <main class="max-w-6xl mx-auto px-5 pb-24" id="root"></main>

  <div id="lightbox" class="fixed inset-0 bg-black/80 z-50 hidden">
    <button id="closeLb" class="absolute top-4 right-4 bg-white/10 hover:bg-white/20 border border-white/20 rounded-xl px-3 py-1.5">Close</button>
    <div class="w-full h-full flex items-center justify-center p-4">
      <div id="lbInner" class="max-w-5xl w-full"></div>
    </div>
  </div>

<script>
const qs = new URLSearchParams(location.search);
const slug = qs.get('slug');
const root = document.getElementById('root');

const lightbox = document.getElementById('lightbox');
const lbInner = document.getElementById('lbInner');
document.getElementById('closeLb').onclick = ()=>{ lightbox.classList.add('hidden'); lbInner.innerHTML=''; }

function openLightbox(item){
  lbInner.innerHTML='';
  if(item.type==='image'){
    const img = new Image();
    img.src=item.src; img.className='w-full h-auto rounded-xl';
    lbInner.appendChild(img);
  }else{
    const vid=document.createElement('video');
    vid.src=item.src; vid.controls=true; vid.autoplay=true; vid.className='w-full h-auto rounded-xl';
    lbInner.appendChild(vid);
  }
  lightbox.classList.remove('hidden');
}

function buildCarousel(media){
  const wrap=document.createElement('div');
  wrap.className='relative fade-slide aspect-[16/10] rounded-2xl overflow-hidden border border-white/10';
  const dots=document.createElement('div');
  dots.className='absolute left-1/2 -translate-x-1/2 bottom-2 flex gap-1.5 z-10';
  media.forEach((m,i)=>{
    let node;
    if(m.type==='image'){
      node=new Image(); node.src=m.src; node.className='w-full h-full object-cover'; node.dataset.idx=i;
    }else{
      node=document.createElement('video');
      node.src=m.src; node.muted=true; node.loop=true; node.playsInline=true; node.dataset.idx=i;
      node.className='w-full h-full object-cover';
      node.oncanplay=()=>node.play().catch(()=>{});
      const pill=document.createElement('div');
      pill.className='absolute right-2 bottom-2 bg-black/60 text-white text-xs px-2 py-1 rounded-full border border-white/20';
      pill.textContent='Play';
      pill.onclick=(e)=>{e.stopPropagation(); openLightbox(m);};
      wrap.appendChild(pill);
      node.addEventListener('click',(e)=>{e.stopPropagation(); openLightbox(m);});
    }
    wrap.appendChild(node);
    const d=document.createElement('button'); d.className='dot'; d.dataset.idx=i; d.onclick=(e)=>{e.stopPropagation(); show(+e.currentTarget.dataset.idx);}; dots.appendChild(d);
  });
  wrap.appendChild(dots);

  let i=0,timer;
  const nodes=[...wrap.querySelectorAll('[data-idx]')];
  const dotEls=[...dots.querySelectorAll('.dot')];
  function show(n){
    i=(n+nodes.length)%nodes.length;
    nodes.forEach(el=>el.classList.remove('active'));
    dotEls.forEach(el=>el.classList.remove('active'));
    nodes[i].classList.add('active'); dotEls[i].classList.add('active');
  }
  function start(){ timer=setInterval(()=>show(i+1),3500); }
  function stop(){ if(timer) clearInterval(timer); }
  wrap.addEventListener('mouseenter', stop);
  wrap.addEventListener('mouseleave', start);
  wrap.addEventListener('click', ()=> openLightbox(media[i]));
  show(0); start();
  return wrap;
}

function stlViewer(container, url){
  const scene=new THREE.Scene();
  scene.background=new THREE.Color(0x0b1322);
  const camera=new THREE.PerspectiveCamera(45, container.clientWidth/container.clientHeight, 0.1, 1000);
  camera.position.set(3,2.2,3.8);

  const renderer=new THREE.WebGLRenderer({antialias:true});
  renderer.setSize(container.clientWidth, container.clientHeight);
  renderer.setPixelRatio(devicePixelRatio);
  container.appendChild(renderer.domElement);

  const controls=new THREE.OrbitControls(camera, renderer.domElement);
  controls.enableDamping=true;

  const hemi=new THREE.HemisphereLight(0xffffff,0x223,0.9); scene.add(hemi);
  const dir=new THREE.DirectionalLight(0xffffff,0.9); dir.position.set(5,10,8); scene.add(dir);

  const loader=new THREE.STLLoader();
  loader.load(url, geo=>{
    geo.computeVertexNormals();
    const mat=new THREE.MeshPhysicalMaterial({color:0x9bbcff, metalness:0.2, roughness:0.35});
    const mesh=new THREE.Mesh(geo, mat);
    geo.computeBoundingBox();
    const box=geo.boundingBox;
    const size=new THREE.Vector3(); box.getSize(size);
    const maxSide=Math.max(size.x,size.y,size.z);
    const s=1/maxSide; mesh.scale.setScalar(s*2.2);
    geo.computeBoundingSphere();
    mesh.position.set(0,0,0);
    mesh.castShadow=true; mesh.receiveShadow=true;
    scene.add(mesh);
  });

  function onResize(){
    const w=container.clientWidth, h=container.clientHeight;
    camera.aspect=w/h; camera.updateProjectionMatrix();
    renderer.setSize(w,h);
  }
  window.addEventListener('resize', onResize);

  (function render(){ requestAnimationFrame(render); controls.update(); renderer.render(scene,camera); })();
}

fetch('projects.json').then(r=>r.json()).then(items=>{
  const p=items.find(x=>x.slug===slug);
  if(!p){ document.getElementById('root').innerHTML='<p class="text-slate-300">Project not found.</p>'; return; }

  const descHTML = `
    <h1 class="text-2xl sm:text-3xl font-semibold">${p.title}</h1>
    <p class="mt-2 text-slate-300">${p.longDescription || p.description || 'Project description coming soon.'}</p>
    <div class="mt-3 flex flex-wrap gap-2">
      ${(p.tags||[]).map(t=>`<span class="text-xs px-2 py-1 rounded-full border border-white/15 bg-white/5">${t}</span>`).join('')}
    </div>
  `;

  const mediaCarousel = buildCarousel(p.media && p.media.length ? p.media : []);
  const isGLB = /\.glb$/i.test(p.model||'');
  const isSTL = /\.stl$/i.test(p.model||'');

  let modelHTML='';
  if(isGLB){
    modelHTML = `<model-viewer src="${p.model}" camera-controls auto-rotate style="width:100%;height:100%;background:#0b1322;border-radius:16px;border:1px solid rgba(255,255,255,.08)"></model-viewer>`;
  } else if(isSTL){
    modelHTML = `<div id="stlHost" class="w-full h-full rounded-2xl border border-white/10"></div>`;
  } else {
    modelHTML = `<div class="w-full h-full rounded-2xl border border-white/10 flex items-center justify-center text-slate-400">No model</div>`;
  }

  document.getElementById('root').innerHTML = `
    <div class="mb-6">${descHTML}</div>
    <div class="grid md:grid-cols-2 gap-6 items-start">
      <div class="min-h-[360px] md:min-h-[420px]">${modelHTML}</div>
      <div class="min-h-[360px] md:min-h-[420px]">${mediaCarousel.outerHTML}</div>
    </div>
  `;

  if(isSTL){
    const host=document.getElementById('stlHost');
    stlViewer(host, p.model);
  }
}).catch(err=>{
  document.getElementById('root').innerHTML = `<p class="text-slate-300">Failed to load project.<br>${err}</p>`;
});
</script>
</body>
</html>
